"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Photo_1 = require("../../../shared/Photo");
var Server_1 = require("../../../shared/Server/Server");
var Comment_1 = require("../../../shared/Comment");
var http = require("http");
var element_registry_1 = require("nativescript-angular/element-registry");
var Data_1 = require("../../../shared/Data");
element_registry_1.registerElement("PullToRefresh", function () { return require("nativescript-pulltorefresh").PullToRefresh; });
var HomeComponent = /** @class */ (function () {
    function HomeComponent(_changeDetectionRef, data) {
        this._changeDetectionRef = _changeDetectionRef;
        this.data = data;
        this.site = "http://188.166.127.207:5555/api.php/";
        console.log("In home constructor");
        this.getPhotos();
        this.selected = false;
        this.photoId = 0;
        this.server = new Server_1.Server();
    }
    HomeComponent.prototype.refreshFeed = function (args) {
        this.getPhotos();
        var pullRefresh = args.object;
        setTimeout(function () {
            pullRefresh.refreshing = false;
        }, 1000);
    };
    //get photos from db, put them in photos array
    HomeComponent.prototype.getPhotos = function () {
        //var _server = new Server();
        //this.photos = _server.getPublicPhotos();
        //console.log("Have " + this.photos.length + " photos");
        var _this = this;
        //testing
        //console.log("In getPhotos");
        this.photos = new Array();
        //get public photos that are not connected to a event, are not in an album and are max 2 days old
        var limitDate = getLimitDate();
        var query = this.site + "files?transform=1&filter[]=file_Permission,eq,public&filter[]=event_Id,is,null&filter[]=album_Id,not,null&filter[]=created_at,gt," + limitDate + "&order=created_at,desc";
        console.log("LIMIT DATE IN QUERY " + query);
        http.getJSON(query)
            .then(function (r) {
            //testing
            //console.log("Files.length is" + r.files.length);
            for (var i = 0; i < r.files.length; i++) {
                console.log("album id " + r.files[i].album_Id);
                _this.photos.push(new Photo_1.Photo(r.files[i].file_Id, "users/" + r.files[i].user_Id + r.files[i].file_URL, r.files[i].user_Id, (r.files[i].created_at).slice(0, 10), r.files[i].file_Description, r.files[i].album_Id, r.files[i].file_Name));
                //testing
                //console.log(r.files[i].file_URL);
            }
        }, function (e) {
            console.log(e);
        });
        /*function getAlbumName(albumId: number, site: string) {
            var albumName = "";
        if (albumId != null) {
            var albumQuery = site + "albums?transform=1&filter=album_Id,eq," + albumId;
            console.log("QQQQQQQQQ" + albumQuery);
            http.getJSON(albumQuery)
            .then((res) => {
                albumName += res.albums[0].album_Name;
            }, function(e) { console.log(e);});
            var replace = / /gi;
            albumName = "/" + albumName.replace(replace, "%20");
        }
            return albumName;
        }*/
        //get string that represents the day before yesterday
        function getLimitDate() {
            var date = new Date();
            console.log("Date is " + date.toDateString());
            date.setDate(date.getDate() - 2);
            console.log("Date new date is " + date.toDateString());
            var dateString = date.getFullYear() + "-";
            var month = date.getMonth() + 1;
            if (month < 10) {
                dateString += "0" + month;
            }
            else {
                dateString += date.getMonth();
            }
            dateString += "-";
            console.log("Day " + date.getDate());
            if (date.getDay() < 10) {
                dateString += "0" + date.getDate();
            }
            else {
                dateString += date.getDate();
            }
            console.log("The date " + dateString);
            return dateString;
        }
    };
    HomeComponent.prototype.selectPhoto = function (args) {
        this.selected = true;
        this.userId = this.data.storage["id"];
        //testing
        //console.log("The id is " + args.view.id);
        //console.log("The event name is " + args.eventName);
        var photo = this.photos.find(function (i) { return i.id === parseInt(args.view.id); });
        this.username = photo.user.firstN + " " + photo.user.lastN;
        this.photoId = photo.id;
        this.photoUrl = photo.url;
        this.photoCreated = photo.created;
        this.photoDescription = photo.description;
        this.photoComments = photo.comments;
        for (var _i = 0, _a = this.photoComments; _i < _a.length; _i++) {
            var c = _a[_i];
            //testing
            //console.log("Checking rights for comments");
            //console.log("comment user id " + c.userId + " loggen in as " + this.userId);
            if (c.userId == this.userId) {
                c.rights = true;
                console.log("Rights changed to true");
            }
        }
        console.log("URL " + this.photoUrl);
    };
    HomeComponent.prototype.closePhoto = function () {
        this.selected = false;
        this.photoUrl = "";
        this.photoCreated = "";
    };
    HomeComponent.prototype.addComment = function (result) {
        console.log("Comment " + result.text);
        if (result.text.length < 1) {
            alert("Cannot insert empty comment");
        }
        else {
            var commentId = this.server.updateComment(this.photoId, this.data.storage["id"], result.text);
            var comment = new Comment_1.Comment(commentId, this.data.storage["id"], result.text);
            comment.rights = true;
            this.photoComments.push(comment);
            result.text = "";
        }
    };
    HomeComponent.prototype.removeComment = function (commentId) {
        console.log("You click comment id " + commentId);
        this.server.removeComment(commentId);
    };
    HomeComponent = __decorate([
        core_1.Component({
            selector: "home-tab",
            templateUrl: "./pages/tabs/home/home.tab.html",
            styleUrls: ["./pages/tabs/home/home.tab.css"]
        }),
        __metadata("design:paramtypes", [core_1.ChangeDetectorRef, Data_1.Data])
    ], HomeComponent);
    return HomeComponent;
}());
exports.HomeComponent = HomeComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9tZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJob21lLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUE2RDtBQUM3RCwrQ0FBOEM7QUFFOUMsd0RBQXVEO0FBQ3ZELG1EQUFrRDtBQUNsRCxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsMEVBQXdFO0FBRXhFLDZDQUE0QztBQUc1QyxrQ0FBZSxDQUFDLGVBQWUsRUFBRyxjQUFLLE9BQUEsT0FBTyxDQUFDLDRCQUE0QixDQUFDLENBQUMsYUFBYSxFQUFuRCxDQUFtRCxDQUFDLENBQUM7QUFRNUY7SUFjSSx1QkFBb0IsbUJBQXNDLEVBQVUsSUFBVTtRQUExRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQW1CO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBTTtRQWI5RSxTQUFJLEdBQVcsc0NBQXNDLENBQUM7UUFjbEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBTSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELG1DQUFXLEdBQVgsVUFBWSxJQUFJO1FBQ1osSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDOUIsVUFBVSxDQUFDO1lBQ1AsV0FBVyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDbkMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2IsQ0FBQztJQUVELDhDQUE4QztJQUM5QyxpQ0FBUyxHQUFUO1FBQ0ksNkJBQTZCO1FBQzdCLDBDQUEwQztRQUMxQyx3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QUMsSUFBSSxDQUFDLENBQUM7WUFDOUYsSUFBSSxPQUFPLEdBQUcsSUFBSSxpQkFBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0UsT0FBTyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakMsTUFBTSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDckIsQ0FBQztJQUNMLENBQUM7SUFFRCxxQ0FBYSxHQUFiLFVBQWMsU0FBUztRQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixHQUFHLFNBQVMsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUEzSlEsYUFBYTtRQU56QixnQkFBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLFVBQVU7WUFDcEIsV0FBVyxFQUFFLGlDQUFpQztZQUM5QyxTQUFTLEVBQUUsQ0FBRSxnQ0FBZ0MsQ0FBRTtTQUNsRCxDQUFDO3lDQWdCMkMsd0JBQWlCLEVBQWdCLFdBQUk7T0FkckUsYUFBYSxDQTZKekI7SUFBRCxvQkFBQztDQUFBLEFBN0pELElBNkpDO0FBN0pZLHNDQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFuZ2VEZXRlY3RvclJlZiB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBQaG90byB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvUGhvdG9cIjtcbmltcG9ydCB7IFVzZXIgfSBmcm9tIFwiLi4vLi4vLi4vc2hhcmVkL1VzZXJcIjtcbmltcG9ydCB7IFNlcnZlciB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvU2VydmVyL1NlcnZlclwiO1xuaW1wb3J0IHsgQ29tbWVudCB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvQ29tbWVudFwiO1xudmFyIGh0dHAgPSByZXF1aXJlKFwiaHR0cFwiKTtcbmltcG9ydCB7IHJlZ2lzdGVyRWxlbWVudCB9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhci9lbGVtZW50LXJlZ2lzdHJ5XCI7XG5pbXBvcnQgeyBHZXN0dXJlRXZlbnREYXRhIH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvZ2VzdHVyZXMvZ2VzdHVyZXNcIjtcbmltcG9ydCB7IERhdGEgfSBmcm9tIFwiLi4vLi4vLi4vc2hhcmVkL0RhdGFcIjtcbmltcG9ydCB7IFRleHRGaWVsZCB9IGZyb20gXCJ1aS90ZXh0LWZpZWxkXCI7XG5cbnJlZ2lzdGVyRWxlbWVudChcIlB1bGxUb1JlZnJlc2hcIiAsICgpPT4gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1wdWxsdG9yZWZyZXNoXCIpLlB1bGxUb1JlZnJlc2gpO1xuIFxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6IFwiaG9tZS10YWJcIixcbiAgICB0ZW1wbGF0ZVVybDogXCIuL3BhZ2VzL3RhYnMvaG9tZS9ob21lLnRhYi5odG1sXCIsXG4gICAgc3R5bGVVcmxzOiBbIFwiLi9wYWdlcy90YWJzL2hvbWUvaG9tZS50YWIuY3NzXCIgXVxufSlcblxuZXhwb3J0IGNsYXNzIEhvbWVDb21wb25lbnQge1xuICAgIHNpdGU6IHN0cmluZyA9IFwiaHR0cDovLzE4OC4xNjYuMTI3LjIwNzo1NTU1L2FwaS5waHAvXCI7XG4gICAgLy9mb3Igc3RvcmluZyBmZXRjaGVkIHBob3Rvc1xuICAgIHB1YmxpYyBwaG90b3M6IEFycmF5PFBob3RvPjtcbiAgICBwdWJsaWMgc2VydmVyOiBTZXJ2ZXI7XG4gICAgcHVibGljIHNlbGVjdGVkOiBib29sZWFuO1xuICAgIHB1YmxpYyBwaG90b0lkOiBudW1iZXI7XG4gICAgcHVibGljIHBob3RvVXJsOiBzdHJpbmc7XG4gICAgcHVibGljIHBob3RvQ3JlYXRlZDogc3RyaW5nO1xuICAgIHB1YmxpYyB1c2VybmFtZTogc3RyaW5nO1xuICAgIHB1YmxpYyBwaG90b0Rlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgcHVibGljIHBob3RvQ29tbWVudHM6IEFycmF5PENvbW1lbnQ+O1xuICAgIHB1YmxpYyB1c2VySWQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NoYW5nZURldGVjdGlvblJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHByaXZhdGUgZGF0YTogRGF0YSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkluIGhvbWUgY29uc3RydWN0b3JcIik7XG4gICAgICAgIHRoaXMuZ2V0UGhvdG9zKCk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5waG90b0lkID0gMDtcbiAgICAgICAgdGhpcy5zZXJ2ZXIgPSBuZXcgU2VydmVyKCk7XG4gICAgfVxuXG4gICAgcmVmcmVzaEZlZWQoYXJncykge1xuICAgICAgICB0aGlzLmdldFBob3RvcygpO1xuICAgICAgICB2YXIgcHVsbFJlZnJlc2ggPSBhcmdzLm9iamVjdDtcbiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHB1bGxSZWZyZXNoLnJlZnJlc2hpbmcgPSBmYWxzZTtcbiAgICAgICAgfSwgMTAwMCk7XG4gICAgfVxuXG4gICAgLy9nZXQgcGhvdG9zIGZyb20gZGIsIHB1dCB0aGVtIGluIHBob3RvcyBhcnJheVxuICAgIGdldFBob3RvcygpIHtcbiAgICAgICAgLy92YXIgX3NlcnZlciA9IG5ldyBTZXJ2ZXIoKTtcbiAgICAgICAgLy90aGlzLnBob3RvcyA9IF9zZXJ2ZXIuZ2V0UHVibGljUGhvdG9zKCk7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJIYXZlIFwiICsgdGhpcy5waG90b3MubGVuZ3RoICsgXCIgcGhvdG9zXCIpO1xuICAgICAgICBcbiAgICAgICAgLy90ZXN0aW5nXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJJbiBnZXRQaG90b3NcIik7XG4gICAgICAgIHRoaXMucGhvdG9zID0gbmV3IEFycmF5KCk7XG4gICAgICAgIC8vZ2V0IHB1YmxpYyBwaG90b3MgdGhhdCBhcmUgbm90IGNvbm5lY3RlZCB0byBhIGV2ZW50LCBhcmUgbm90IGluIGFuIGFsYnVtIGFuZCBhcmUgbWF4IDIgZGF5cyBvbGRcbiAgICAgICAgdmFyIGxpbWl0RGF0ZTogc3RyaW5nID0gZ2V0TGltaXREYXRlKCk7XG4gICAgICAgIHZhciBxdWVyeTogc3RyaW5nID0gdGhpcy5zaXRlICsgXCJmaWxlcz90cmFuc2Zvcm09MSZmaWx0ZXJbXT1maWxlX1Blcm1pc3Npb24sZXEscHVibGljJmZpbHRlcltdPWV2ZW50X0lkLGlzLG51bGwmZmlsdGVyW109YWxidW1fSWQsbm90LG51bGwmZmlsdGVyW109Y3JlYXRlZF9hdCxndCxcIiArIGxpbWl0RGF0ZSArIFwiJm9yZGVyPWNyZWF0ZWRfYXQsZGVzY1wiO1xuICAgICAgICBjb25zb2xlLmxvZyhcIkxJTUlUIERBVEUgSU4gUVVFUlkgXCIgKyBxdWVyeSk7XG4gICAgICAgIGh0dHAuZ2V0SlNPTihxdWVyeSlcbiAgICAgICAgLnRoZW4oKHIpID0+IHtcbiAgICAgICAgICAgIC8vdGVzdGluZ1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIkZpbGVzLmxlbmd0aCBpc1wiICsgci5maWxlcy5sZW5ndGgpO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByLmZpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJhbGJ1bSBpZCBcIiArIHIuZmlsZXNbaV0uYWxidW1fSWQpO1xuICAgICAgICAgICAgICAgIHRoaXMucGhvdG9zLnB1c2goXG4gICAgICAgICAgICAgICAgICAgIG5ldyBQaG90byhcbiAgICAgICAgICAgICAgICAgICAgICAgIHIuZmlsZXNbaV0uZmlsZV9JZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidXNlcnMvXCIgKyByLmZpbGVzW2ldLnVzZXJfSWQgKyByLmZpbGVzW2ldLmZpbGVfVVJMLFxuICAgICAgICAgICAgICAgICAgICAgICAgci5maWxlc1tpXS51c2VyX0lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgKHIuZmlsZXNbaV0uY3JlYXRlZF9hdCkuc2xpY2UoMCwxMCksXG4gICAgICAgICAgICAgICAgICAgICAgICByLmZpbGVzW2ldLmZpbGVfRGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICByLmZpbGVzW2ldLmFsYnVtX0lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgci5maWxlc1tpXS5maWxlX05hbWVcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAvL3Rlc3RpbmdcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKHIuZmlsZXNbaV0uZmlsZV9VUkwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8qZnVuY3Rpb24gZ2V0QWxidW1OYW1lKGFsYnVtSWQ6IG51bWJlciwgc2l0ZTogc3RyaW5nKSB7XG4gICAgICAgICAgICB2YXIgYWxidW1OYW1lID0gXCJcIjtcbiAgICAgICAgaWYgKGFsYnVtSWQgIT0gbnVsbCkge1xuICAgICAgICAgICAgdmFyIGFsYnVtUXVlcnkgPSBzaXRlICsgXCJhbGJ1bXM/dHJhbnNmb3JtPTEmZmlsdGVyPWFsYnVtX0lkLGVxLFwiICsgYWxidW1JZDtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUVFRUVFRUVFRXCIgKyBhbGJ1bVF1ZXJ5KTtcbiAgICAgICAgICAgIGh0dHAuZ2V0SlNPTihhbGJ1bVF1ZXJ5KVxuICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGFsYnVtTmFtZSArPSByZXMuYWxidW1zWzBdLmFsYnVtX05hbWU7XG4gICAgICAgICAgICB9LCBmdW5jdGlvbihlKSB7IGNvbnNvbGUubG9nKGUpO30pO1xuICAgICAgICAgICAgdmFyIHJlcGxhY2UgPSAvIC9naTtcbiAgICAgICAgICAgIGFsYnVtTmFtZSA9IFwiL1wiICsgYWxidW1OYW1lLnJlcGxhY2UocmVwbGFjZSwgXCIlMjBcIik7XG4gICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhbGJ1bU5hbWU7XG4gICAgICAgIH0qL1xuXG4gICAgICAgIC8vZ2V0IHN0cmluZyB0aGF0IHJlcHJlc2VudHMgdGhlIGRheSBiZWZvcmUgeWVzdGVyZGF5XG4gICAgICAgIGZ1bmN0aW9uIGdldExpbWl0RGF0ZSgpIHtcbiAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRGF0ZSBpcyBcIiArIGRhdGUudG9EYXRlU3RyaW5nKCkpO1xuICAgICAgICAgICAgZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpLTIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJEYXRlIG5ldyBkYXRlIGlzIFwiICsgZGF0ZS50b0RhdGVTdHJpbmcoKSk7XG4gICAgICAgICAgICB2YXIgZGF0ZVN0cmluZyA9IGRhdGUuZ2V0RnVsbFllYXIoKSArIFwiLVwiO1xuICAgICAgICAgICAgdmFyIG1vbnRoOiBudW1iZXIgPSBkYXRlLmdldE1vbnRoKCkgKyAxO1xuICAgICAgICAgICAgaWYgKG1vbnRoIDwgMTApIHtcbiAgICAgICAgICAgICAgICBkYXRlU3RyaW5nICs9IFwiMFwiICsgbW9udGg7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRhdGVTdHJpbmcgKz0gZGF0ZS5nZXRNb250aCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGF0ZVN0cmluZyArPSBcIi1cIjtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRGF5IFwiICsgZGF0ZS5nZXREYXRlKCkpXG4gICAgICAgICAgICBpZiAoZGF0ZS5nZXREYXkoKSA8IDEwKSB7XG4gICAgICAgICAgICAgICAgZGF0ZVN0cmluZyArPSBcIjBcIiArIGRhdGUuZ2V0RGF0ZSgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkYXRlU3RyaW5nICs9IGRhdGUuZ2V0RGF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUaGUgZGF0ZSBcIiArIGRhdGVTdHJpbmcpO1xuICAgICAgICAgICAgcmV0dXJuIGRhdGVTdHJpbmc7XG4gICAgICAgIH1cbiAgICAgICBcbiAgICB9XG5cbiAgICBzZWxlY3RQaG90byhhcmdzOiBHZXN0dXJlRXZlbnREYXRhKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLnVzZXJJZCA9IHRoaXMuZGF0YS5zdG9yYWdlW1wiaWRcIl07XG4gICAgICAgIC8vdGVzdGluZ1xuICAgICAgICAvL2NvbnNvbGUubG9nKFwiVGhlIGlkIGlzIFwiICsgYXJncy52aWV3LmlkKTtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcIlRoZSBldmVudCBuYW1lIGlzIFwiICsgYXJncy5ldmVudE5hbWUpO1xuICAgICAgICB2YXIgcGhvdG86IFBob3RvID0gdGhpcy5waG90b3MuZmluZChpID0+IGkuaWQgPT09IHBhcnNlSW50KGFyZ3Mudmlldy5pZCkpO1xuICAgICAgICB0aGlzLnVzZXJuYW1lID0gcGhvdG8udXNlci5maXJzdE4gKyBcIiBcIiArIHBob3RvLnVzZXIubGFzdE47XG4gICAgICAgIHRoaXMucGhvdG9JZCA9IHBob3RvLmlkO1xuICAgICAgICB0aGlzLnBob3RvVXJsID0gcGhvdG8udXJsO1xuICAgICAgICB0aGlzLnBob3RvQ3JlYXRlZCA9IHBob3RvLmNyZWF0ZWQ7XG4gICAgICAgIHRoaXMucGhvdG9EZXNjcmlwdGlvbiA9IHBob3RvLmRlc2NyaXB0aW9uO1xuICAgICAgICB0aGlzLnBob3RvQ29tbWVudHMgPSBwaG90by5jb21tZW50cztcbiAgICAgICAgZm9yIChsZXQgYyBvZiB0aGlzLnBob3RvQ29tbWVudHMpIHtcbiAgICAgICAgICAgIC8vdGVzdGluZ1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIkNoZWNraW5nIHJpZ2h0cyBmb3IgY29tbWVudHNcIik7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiY29tbWVudCB1c2VyIGlkIFwiICsgYy51c2VySWQgKyBcIiBsb2dnZW4gaW4gYXMgXCIgKyB0aGlzLnVzZXJJZCk7XG4gICAgICAgICAgICBpZiAoYy51c2VySWQgPT0gdGhpcy51c2VySWQpIHtcbiAgICAgICAgICAgICAgICBjLnJpZ2h0cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJSaWdodHMgY2hhbmdlZCB0byB0cnVlXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwiVVJMIFwiICsgdGhpcy5waG90b1VybCk7XG4gICAgfVxuXG4gICAgY2xvc2VQaG90bygpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBob3RvVXJsID0gXCJcIjtcbiAgICAgICAgdGhpcy5waG90b0NyZWF0ZWQgPSBcIlwiO1xuICAgIH1cblxuICAgIGFkZENvbW1lbnQocmVzdWx0KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ29tbWVudCBcIiArIHJlc3VsdC50ZXh0KTtcbiAgICAgICAgaWYgKHJlc3VsdC50ZXh0Lmxlbmd0aCA8IDEpIHtcbiAgICAgICAgICAgIGFsZXJ0KFwiQ2Fubm90IGluc2VydCBlbXB0eSBjb21tZW50XCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGNvbW1lbnRJZCA9IHRoaXMuc2VydmVyLnVwZGF0ZUNvbW1lbnQodGhpcy5waG90b0lkLCB0aGlzLmRhdGEuc3RvcmFnZVtcImlkXCJdLCByZXN1bHQudGV4dCk7XG4gICAgICAgICAgICB2YXIgY29tbWVudCA9IG5ldyBDb21tZW50KGNvbW1lbnRJZCwgdGhpcy5kYXRhLnN0b3JhZ2VbXCJpZFwiXSwgcmVzdWx0LnRleHQpO1xuICAgICAgICAgICAgY29tbWVudC5yaWdodHMgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5waG90b0NvbW1lbnRzLnB1c2goY29tbWVudCk7XG4gICAgICAgICAgICByZXN1bHQudGV4dCA9IFwiXCI7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW1vdmVDb21tZW50KGNvbW1lbnRJZCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIllvdSBjbGljayBjb21tZW50IGlkIFwiICsgY29tbWVudElkKTtcbiAgICAgICAgdGhpcy5zZXJ2ZXIucmVtb3ZlQ29tbWVudChjb21tZW50SWQpO1xuICAgIH1cblxufSJdfQ==