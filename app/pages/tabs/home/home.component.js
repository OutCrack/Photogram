"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Photo_1 = require("../../../shared/Photo");
var Server_1 = require("../../../shared/Server/Server");
var Comment_1 = require("../../../shared/Comment");
var http = require("http");
var element_registry_1 = require("nativescript-angular/element-registry");
var Data_1 = require("../../../shared/Data");
element_registry_1.registerElement("PullToRefresh", function () { return require("nativescript-pulltorefresh").PullToRefresh; });
var HomeComponent = /** @class */ (function () {
    function HomeComponent(_changeDetectionRef, data) {
        this._changeDetectionRef = _changeDetectionRef;
        this.data = data;
        this.site = "http://188.166.127.207:5555/api.php/";
        console.log("In home constructor");
        this.getPhotos();
        this.selected = false;
        this.photoId = 0;
        this.server = new Server_1.Server();
    }
    HomeComponent.prototype.refreshFeed = function (args) {
        this.getPhotos();
        var pullRefresh = args.object;
        setTimeout(function () {
            pullRefresh.refreshing = false;
        }, 1000);
    };
    //get photos from db, put them in photos array
    HomeComponent.prototype.getPhotos = function () {
        //var _server = new Server();
        //this.photos = _server.getPublicPhotos();
        //console.log("Have " + this.photos.length + " photos");
        var _this = this;
        //testing
        //console.log("In getPhotos");
        this.photos = new Array();
        //get public photos that are not connected to a event, are not in an album and are max 2 days old
        var limitDate = getLimitDate();
        var query = this.site + "files?transform=1&filter[]=file_Permission,eq,public&filter[]=event_Id,is,null&filter[]=created_at,gt," + limitDate + "&filter[]=album_Id,is,null&order=created_at,desc";
        console.log("LIMIT DATE IN QUERY " + query);
        http.getJSON(query)
            .then(function (r) {
            //testing
            //console.log("Files.length is" + r.files.length);
            for (var i = 0; i < r.files.length; i++) {
                var albumName = getAlbumName(r.files[i].album_Id, _this.site);
                console.log("Album name " + albumName);
                _this.photos.push(new Photo_1.Photo(r.files[i].file_Id, "users/" + r.files[i].user_Id + albumName + "/" + r.files[i].file_URL, r.files[i].user_Id, (r.files[i].created_at).slice(0, 10), r.files[i].file_Description, r.files[i].album_id, r.files[i].file_Name));
                //testing
                //console.log(r.files[i].file_URL);
            }
        }, function (e) {
            console.log(e);
        });
        function getAlbumName(albumId, site) {
            var albumName = "";
            if (albumId != null) {
                var albumQuery = site + "albums?transform=1&filter=album_Id,eq," + albumId;
                console.log("QQQQQQQQQ" + albumQuery);
                http.getJSON(albumQuery)
                    .then(function (res) {
                    albumName += res.albums[0].album_Name;
                }, function (e) { console.log(e); });
                var replace = / /gi;
                albumName = "/" + albumName.replace(replace, "%20");
            }
            return albumName;
        }
        //get string that represents the day before yesterday
        function getLimitDate() {
            var date = new Date();
            console.log("Date is " + date.toDateString());
            date.setDate(date.getDate() - 2); //Antall dager gamle bilder som skal vises
            console.log("Date new date is " + date.toDateString());
            var dateString = date.getFullYear() + "-";
            var month = date.getMonth() + 1;
            if (month < 10) {
                dateString += "0" + month;
            }
            else {
                dateString += date.getMonth();
            }
            dateString += "-";
            console.log("Day " + date.getDate());
            if (date.getDay() < 10) {
                dateString += "0" + date.getDate();
            }
            else {
                dateString += date.getDate();
            }
            console.log("The date " + dateString);
            return dateString;
        }
    };
    HomeComponent.prototype.selectPhoto = function (args) {
        this.selected = true;
        this.userId = this.data.storage["id"];
        //testing
        //console.log("The id is " + args.view.id);
        //console.log("The event name is " + args.eventName);
        var photo = this.photos.find(function (i) { return i.id === parseInt(args.view.id); });
        this.username = photo.user.firstN + " " + photo.user.lastN;
        this.photoId = photo.id;
        this.photoUrl = photo.url;
        this.photoCreated = photo.created;
        this.photoDescription = photo.description;
        this.photoComments = photo.comments;
        for (var _i = 0, _a = this.photoComments; _i < _a.length; _i++) {
            var c = _a[_i];
            //testing
            //console.log("Checking rights for comments");
            //console.log("comment user id " + c.userId + " loggen in as " + this.userId);
            if (c.userId == this.userId) {
                c.rights = true;
                console.log("Rights changed to true");
            }
        }
        console.log("URL " + this.photoUrl);
    };
    HomeComponent.prototype.closePhoto = function () {
        this.selected = false;
        this.photoUrl = "";
        this.photoCreated = "";
    };
    HomeComponent.prototype.addComment = function (result) {
        console.log("Comment " + result.text);
        if (result.text.length < 1) {
            alert("Cannot insert empty comment");
        }
        else {
            var commentId = this.server.updateComment(this.photoId, this.data.storage["id"], result.text);
            var comment = new Comment_1.Comment(commentId, this.data.storage["id"], result.text);
            comment.rights = true;
            this.photoComments.push(comment);
            result.text = "";
        }
    };
    HomeComponent.prototype.removeComment = function (commentId) {
        console.log("You click comment id " + commentId);
        this.server.removeComment(commentId);
    };
    HomeComponent = __decorate([
        core_1.Component({
            selector: "home-tab",
            templateUrl: "./pages/tabs/home/home.tab.html",
            styleUrls: ["./pages/tabs/home/home.tab.css"]
        }),
        __metadata("design:paramtypes", [core_1.ChangeDetectorRef, Data_1.Data])
    ], HomeComponent);
    return HomeComponent;
}());
exports.HomeComponent = HomeComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9tZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJob21lLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUE2RDtBQUM3RCwrQ0FBOEM7QUFFOUMsd0RBQXVEO0FBQ3ZELG1EQUFrRDtBQUNsRCxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsMEVBQXdFO0FBRXhFLDZDQUE0QztBQUc1QyxrQ0FBZSxDQUFDLGVBQWUsRUFBRyxjQUFLLE9BQUEsT0FBTyxDQUFDLDRCQUE0QixDQUFDLENBQUMsYUFBYSxFQUFuRCxDQUFtRCxDQUFDLENBQUM7QUFRNUY7SUFjSSx1QkFBb0IsbUJBQXNDLEVBQVUsSUFBVTtRQUExRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQW1CO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBTTtRQWI5RSxTQUFJLEdBQVcsc0NBQXNDLENBQUM7UUFjbEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBTSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELG1DQUFXLEdBQVgsVUFBWSxJQUFJO1FBQ1osSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDOUIsVUFBVSxDQUFDO1lBQ1AsV0FBVyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDbkMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2IsQ0FBQztJQUVELDhDQUE4QztJQUM5QyxpQ0FBUyxHQUFUO1FBQ0ksNkJBQTZCO1FBQzdCLDBDQUEwQztRQUMxQyx3REFBd0Q7UUFINUQsaUJBNkVDO1FBeEVHLFNBQVM7UUFDVCw4QkFBOEI7UUFDOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzFCLGlHQUFpRztRQUNqRyxJQUFJLFNBQVMsR0FBVyxZQUFZLEVBQUUsQ0FBQztRQUN2QyxJQUFJLEtBQUssR0FBVyxJQUFJLENBQUMsSUFBSSxHQUFHLHdHQUF3RyxHQUFHLFNBQVMsR0FBRyxrREFBa0QsQ0FBQztRQUMxTSxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO2FBQ2xCLElBQUksQ0FBQyxVQUFDLENBQUM7WUFDSixTQUFTO1lBQ1Qsa0RBQWtEO1lBQ2xELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDdEMsSUFBSSxTQUFTLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEtBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFN0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFDLENBQUM7Z0JBQ3ZDLEtBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNaLElBQUksYUFBSyxDQUNMLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUNsQixRQUFRLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsU0FBUyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFDckUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQ2xCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxFQUNuQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixFQUMzQixDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFDbkIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQ3ZCLENBQ0osQ0FBQTtnQkFDRCxTQUFTO2dCQUNULG1DQUFtQztZQUN2QyxDQUFDO1FBQ0wsQ0FBQyxFQUFFLFVBQVUsQ0FBQztZQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFFSCxzQkFBc0IsT0FBZSxFQUFFLElBQVk7WUFDL0MsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO1lBQ3ZCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNsQixJQUFJLFVBQVUsR0FBRyxJQUFJLEdBQUcsd0NBQXdDLEdBQUcsT0FBTyxDQUFDO2dCQUMzRSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7cUJBQ3ZCLElBQUksQ0FBQyxVQUFDLEdBQUc7b0JBQ04sU0FBUyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO2dCQUMxQyxDQUFDLEVBQUUsVUFBUyxDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQyxDQUFDO2dCQUNuQyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7Z0JBQ3BCLFNBQVMsR0FBRyxHQUFHLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDeEQsQ0FBQztZQUNHLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDckIsQ0FBQztRQUVELHFEQUFxRDtRQUNyRDtZQUNJLElBQUksSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7WUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7WUFDOUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQywwQ0FBMEM7WUFDNUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztZQUN2RCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLEdBQUcsR0FBRyxDQUFDO1lBQzFDLElBQUksS0FBSyxHQUFXLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDeEMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2IsVUFBVSxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUM7WUFDOUIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDbEMsQ0FBQztZQUNELFVBQVUsSUFBSSxHQUFHLENBQUM7WUFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUE7WUFDcEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JCLFVBQVUsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3ZDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2pDLENBQUM7WUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsVUFBVSxDQUFDO1FBQ3RCLENBQUM7SUFFTCxDQUFDO0lBRUQsbUNBQVcsR0FBWCxVQUFZLElBQXNCO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsU0FBUztRQUNULDJDQUEyQztRQUMzQyxxREFBcUQ7UUFDckQsSUFBSSxLQUFLLEdBQVUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUEvQixDQUErQixDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDM0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztRQUMxQixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDbEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7UUFDMUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQ3BDLEdBQUcsQ0FBQyxDQUFVLFVBQWtCLEVBQWxCLEtBQUEsSUFBSSxDQUFDLGFBQWEsRUFBbEIsY0FBa0IsRUFBbEIsSUFBa0I7WUFBM0IsSUFBSSxDQUFDLFNBQUE7WUFDTixTQUFTO1lBQ1QsOENBQThDO1lBQzlDLDhFQUE4RTtZQUM5RSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztnQkFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1lBQzFDLENBQUM7U0FDSjtRQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsa0NBQVUsR0FBVjtRQUNJLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxrQ0FBVSxHQUFWLFVBQVcsTUFBTTtRQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlGLElBQUksT0FBTyxHQUFHLElBQUksaUJBQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzNFLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLENBQUM7SUFDTCxDQUFDO0lBRUQscUNBQWEsR0FBYixVQUFjLFNBQVM7UUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsR0FBRyxTQUFTLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBN0pRLGFBQWE7UUFOekIsZ0JBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxVQUFVO1lBQ3BCLFdBQVcsRUFBRSxpQ0FBaUM7WUFDOUMsU0FBUyxFQUFFLENBQUUsZ0NBQWdDLENBQUU7U0FDbEQsQ0FBQzt5Q0FnQjJDLHdCQUFpQixFQUFnQixXQUFJO09BZHJFLGFBQWEsQ0ErSnpCO0lBQUQsb0JBQUM7Q0FBQSxBQS9KRCxJQStKQztBQS9KWSxzQ0FBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBQaG90byB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvUGhvdG9cIjtcclxuaW1wb3J0IHsgVXNlciB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvVXNlclwiO1xyXG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tIFwiLi4vLi4vLi4vc2hhcmVkL1NlcnZlci9TZXJ2ZXJcIjtcclxuaW1wb3J0IHsgQ29tbWVudCB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvQ29tbWVudFwiO1xyXG52YXIgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xyXG5pbXBvcnQgeyByZWdpc3RlckVsZW1lbnQgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFuZ3VsYXIvZWxlbWVudC1yZWdpc3RyeVwiO1xyXG5pbXBvcnQgeyBHZXN0dXJlRXZlbnREYXRhIH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvZ2VzdHVyZXMvZ2VzdHVyZXNcIjtcclxuaW1wb3J0IHsgRGF0YSB9IGZyb20gXCIuLi8uLi8uLi9zaGFyZWQvRGF0YVwiO1xyXG5pbXBvcnQgeyBUZXh0RmllbGQgfSBmcm9tIFwidWkvdGV4dC1maWVsZFwiO1xyXG5cclxucmVnaXN0ZXJFbGVtZW50KFwiUHVsbFRvUmVmcmVzaFwiICwgKCk9PiByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXB1bGx0b3JlZnJlc2hcIikuUHVsbFRvUmVmcmVzaCk7XHJcbiBcclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogXCJob21lLXRhYlwiLFxyXG4gICAgdGVtcGxhdGVVcmw6IFwiLi9wYWdlcy90YWJzL2hvbWUvaG9tZS50YWIuaHRtbFwiLFxyXG4gICAgc3R5bGVVcmxzOiBbIFwiLi9wYWdlcy90YWJzL2hvbWUvaG9tZS50YWIuY3NzXCIgXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEhvbWVDb21wb25lbnQge1xyXG4gICAgc2l0ZTogc3RyaW5nID0gXCJodHRwOi8vMTg4LjE2Ni4xMjcuMjA3OjU1NTUvYXBpLnBocC9cIjtcclxuICAgIC8vZm9yIHN0b3JpbmcgZmV0Y2hlZCBwaG90b3NcclxuICAgIHB1YmxpYyBwaG90b3M6IEFycmF5PFBob3RvPjtcclxuICAgIHB1YmxpYyBzZXJ2ZXI6IFNlcnZlcjtcclxuICAgIHB1YmxpYyBzZWxlY3RlZDogYm9vbGVhbjtcclxuICAgIHB1YmxpYyBwaG90b0lkOiBudW1iZXI7XHJcbiAgICBwdWJsaWMgcGhvdG9Vcmw6IHN0cmluZztcclxuICAgIHB1YmxpYyBwaG90b0NyZWF0ZWQ6IHN0cmluZztcclxuICAgIHB1YmxpYyB1c2VybmFtZTogc3RyaW5nO1xyXG4gICAgcHVibGljIHBob3RvRGVzY3JpcHRpb246IHN0cmluZztcclxuICAgIHB1YmxpYyBwaG90b0NvbW1lbnRzOiBBcnJheTxDb21tZW50PjtcclxuICAgIHB1YmxpYyB1c2VySWQ6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9jaGFuZ2VEZXRlY3Rpb25SZWY6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIGRhdGE6IERhdGEpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIkluIGhvbWUgY29uc3RydWN0b3JcIik7XHJcbiAgICAgICAgdGhpcy5nZXRQaG90b3MoKTtcclxuICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5waG90b0lkID0gMDtcclxuICAgICAgICB0aGlzLnNlcnZlciA9IG5ldyBTZXJ2ZXIoKTtcclxuICAgIH1cclxuXHJcbiAgICByZWZyZXNoRmVlZChhcmdzKSB7XHJcbiAgICAgICAgdGhpcy5nZXRQaG90b3MoKTtcclxuICAgICAgICB2YXIgcHVsbFJlZnJlc2ggPSBhcmdzLm9iamVjdDtcclxuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBwdWxsUmVmcmVzaC5yZWZyZXNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgfSwgMTAwMCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy9nZXQgcGhvdG9zIGZyb20gZGIsIHB1dCB0aGVtIGluIHBob3RvcyBhcnJheVxyXG4gICAgZ2V0UGhvdG9zKCkge1xyXG4gICAgICAgIC8vdmFyIF9zZXJ2ZXIgPSBuZXcgU2VydmVyKCk7XHJcbiAgICAgICAgLy90aGlzLnBob3RvcyA9IF9zZXJ2ZXIuZ2V0UHVibGljUGhvdG9zKCk7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcIkhhdmUgXCIgKyB0aGlzLnBob3Rvcy5sZW5ndGggKyBcIiBwaG90b3NcIik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy90ZXN0aW5nXHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcIkluIGdldFBob3Rvc1wiKTtcclxuICAgICAgICB0aGlzLnBob3RvcyA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIC8vZ2V0IHB1YmxpYyBwaG90b3MgdGhhdCBhcmUgbm90IGNvbm5lY3RlZCB0byBhIGV2ZW50LCBhcmUgbm90IGluIGFuIGFsYnVtIGFuZCBhcmUgbWF4IDIgZGF5cyBvbGRcclxuICAgICAgICB2YXIgbGltaXREYXRlOiBzdHJpbmcgPSBnZXRMaW1pdERhdGUoKTtcclxuICAgICAgICB2YXIgcXVlcnk6IHN0cmluZyA9IHRoaXMuc2l0ZSArIFwiZmlsZXM/dHJhbnNmb3JtPTEmZmlsdGVyW109ZmlsZV9QZXJtaXNzaW9uLGVxLHB1YmxpYyZmaWx0ZXJbXT1ldmVudF9JZCxpcyxudWxsJmZpbHRlcltdPWNyZWF0ZWRfYXQsZ3QsXCIgKyBsaW1pdERhdGUgKyBcIiZmaWx0ZXJbXT1hbGJ1bV9JZCxpcyxudWxsJm9yZGVyPWNyZWF0ZWRfYXQsZGVzY1wiO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiTElNSVQgREFURSBJTiBRVUVSWSBcIiArIHF1ZXJ5KTtcclxuICAgICAgICBodHRwLmdldEpTT04ocXVlcnkpXHJcbiAgICAgICAgLnRoZW4oKHIpID0+IHtcclxuICAgICAgICAgICAgLy90ZXN0aW5nXHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJGaWxlcy5sZW5ndGggaXNcIiArIHIuZmlsZXMubGVuZ3RoKTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByLmZpbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWxidW1OYW1lID0gZ2V0QWxidW1OYW1lKHIuZmlsZXNbaV0uYWxidW1fSWQsIHRoaXMuc2l0ZSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQWxidW0gbmFtZSBcIiArIGFsYnVtTmFtZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBob3Rvcy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgICAgIG5ldyBQaG90byhcclxuICAgICAgICAgICAgICAgICAgICAgICAgci5maWxlc1tpXS5maWxlX0lkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcInVzZXJzL1wiICsgci5maWxlc1tpXS51c2VyX0lkICsgYWxidW1OYW1lICsgXCIvXCIgKyByLmZpbGVzW2ldLmZpbGVfVVJMLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByLmZpbGVzW2ldLnVzZXJfSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChyLmZpbGVzW2ldLmNyZWF0ZWRfYXQpLnNsaWNlKDAsMTApLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByLmZpbGVzW2ldLmZpbGVfRGVzY3JpcHRpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHIuZmlsZXNbaV0uYWxidW1faWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHIuZmlsZXNbaV0uZmlsZV9OYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgLy90ZXN0aW5nXHJcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKHIuZmlsZXNbaV0uZmlsZV9VUkwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGdldEFsYnVtTmFtZShhbGJ1bUlkOiBudW1iZXIsIHNpdGU6IHN0cmluZykge1xyXG4gICAgICAgICAgICB2YXIgYWxidW1OYW1lID0gXCJcIjtcclxuICAgICAgICBpZiAoYWxidW1JZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHZhciBhbGJ1bVF1ZXJ5ID0gc2l0ZSArIFwiYWxidW1zP3RyYW5zZm9ybT0xJmZpbHRlcj1hbGJ1bV9JZCxlcSxcIiArIGFsYnVtSWQ7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUVFRUVFRUVFRXCIgKyBhbGJ1bVF1ZXJ5KTtcclxuICAgICAgICAgICAgaHR0cC5nZXRKU09OKGFsYnVtUXVlcnkpXHJcbiAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIGFsYnVtTmFtZSArPSByZXMuYWxidW1zWzBdLmFsYnVtX05hbWU7XHJcbiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGUpIHsgY29uc29sZS5sb2coZSk7fSk7XHJcbiAgICAgICAgICAgIHZhciByZXBsYWNlID0gLyAvZ2k7XHJcbiAgICAgICAgICAgIGFsYnVtTmFtZSA9IFwiL1wiICsgYWxidW1OYW1lLnJlcGxhY2UocmVwbGFjZSwgXCIlMjBcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gYWxidW1OYW1lO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9nZXQgc3RyaW5nIHRoYXQgcmVwcmVzZW50cyB0aGUgZGF5IGJlZm9yZSB5ZXN0ZXJkYXlcclxuICAgICAgICBmdW5jdGlvbiBnZXRMaW1pdERhdGUoKSB7XHJcbiAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJEYXRlIGlzIFwiICsgZGF0ZS50b0RhdGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIGRhdGUuc2V0RGF0ZShkYXRlLmdldERhdGUoKSAtIDIpOyAvL0FudGFsbCBkYWdlciBnYW1sZSBiaWxkZXIgc29tIHNrYWwgdmlzZXNcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJEYXRlIG5ldyBkYXRlIGlzIFwiICsgZGF0ZS50b0RhdGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIHZhciBkYXRlU3RyaW5nID0gZGF0ZS5nZXRGdWxsWWVhcigpICsgXCItXCI7XHJcbiAgICAgICAgICAgIHZhciBtb250aDogbnVtYmVyID0gZGF0ZS5nZXRNb250aCgpICsgMTtcclxuICAgICAgICAgICAgaWYgKG1vbnRoIDwgMTApIHtcclxuICAgICAgICAgICAgICAgIGRhdGVTdHJpbmcgKz0gXCIwXCIgKyBtb250aDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRhdGVTdHJpbmcgKz0gZGF0ZS5nZXRNb250aCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRhdGVTdHJpbmcgKz0gXCItXCI7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRGF5IFwiICsgZGF0ZS5nZXREYXRlKCkpXHJcbiAgICAgICAgICAgIGlmIChkYXRlLmdldERheSgpIDwgMTApIHtcclxuICAgICAgICAgICAgICAgIGRhdGVTdHJpbmcgKz0gXCIwXCIgKyBkYXRlLmdldERhdGUoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRhdGVTdHJpbmcgKz0gZGF0ZS5nZXREYXRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUaGUgZGF0ZSBcIiArIGRhdGVTdHJpbmcpO1xyXG4gICAgICAgICAgICByZXR1cm4gZGF0ZVN0cmluZztcclxuICAgICAgICB9XHJcbiAgICAgICBcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RQaG90byhhcmdzOiBHZXN0dXJlRXZlbnREYXRhKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgdGhpcy51c2VySWQgPSB0aGlzLmRhdGEuc3RvcmFnZVtcImlkXCJdO1xyXG4gICAgICAgIC8vdGVzdGluZ1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJUaGUgaWQgaXMgXCIgKyBhcmdzLnZpZXcuaWQpO1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJUaGUgZXZlbnQgbmFtZSBpcyBcIiArIGFyZ3MuZXZlbnROYW1lKTtcclxuICAgICAgICB2YXIgcGhvdG86IFBob3RvID0gdGhpcy5waG90b3MuZmluZChpID0+IGkuaWQgPT09IHBhcnNlSW50KGFyZ3Mudmlldy5pZCkpO1xyXG4gICAgICAgIHRoaXMudXNlcm5hbWUgPSBwaG90by51c2VyLmZpcnN0TiArIFwiIFwiICsgcGhvdG8udXNlci5sYXN0TjtcclxuICAgICAgICB0aGlzLnBob3RvSWQgPSBwaG90by5pZDtcclxuICAgICAgICB0aGlzLnBob3RvVXJsID0gcGhvdG8udXJsO1xyXG4gICAgICAgIHRoaXMucGhvdG9DcmVhdGVkID0gcGhvdG8uY3JlYXRlZDtcclxuICAgICAgICB0aGlzLnBob3RvRGVzY3JpcHRpb24gPSBwaG90by5kZXNjcmlwdGlvbjtcclxuICAgICAgICB0aGlzLnBob3RvQ29tbWVudHMgPSBwaG90by5jb21tZW50cztcclxuICAgICAgICBmb3IgKGxldCBjIG9mIHRoaXMucGhvdG9Db21tZW50cykge1xyXG4gICAgICAgICAgICAvL3Rlc3RpbmdcclxuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIkNoZWNraW5nIHJpZ2h0cyBmb3IgY29tbWVudHNcIik7XHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJjb21tZW50IHVzZXIgaWQgXCIgKyBjLnVzZXJJZCArIFwiIGxvZ2dlbiBpbiBhcyBcIiArIHRoaXMudXNlcklkKTtcclxuICAgICAgICAgICAgaWYgKGMudXNlcklkID09IHRoaXMudXNlcklkKSB7XHJcbiAgICAgICAgICAgICAgICBjLnJpZ2h0cyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJpZ2h0cyBjaGFuZ2VkIHRvIHRydWVcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJVUkwgXCIgKyB0aGlzLnBob3RvVXJsKTtcclxuICAgIH1cclxuXHJcbiAgICBjbG9zZVBob3RvKCkge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnBob3RvVXJsID0gXCJcIjtcclxuICAgICAgICB0aGlzLnBob3RvQ3JlYXRlZCA9IFwiXCI7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkQ29tbWVudChyZXN1bHQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIkNvbW1lbnQgXCIgKyByZXN1bHQudGV4dCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdC50ZXh0Lmxlbmd0aCA8IDEpIHtcclxuICAgICAgICAgICAgYWxlcnQoXCJDYW5ub3QgaW5zZXJ0IGVtcHR5IGNvbW1lbnRcIik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFyIGNvbW1lbnRJZCA9IHRoaXMuc2VydmVyLnVwZGF0ZUNvbW1lbnQodGhpcy5waG90b0lkLCB0aGlzLmRhdGEuc3RvcmFnZVtcImlkXCJdLCByZXN1bHQudGV4dCk7XHJcbiAgICAgICAgICAgIHZhciBjb21tZW50ID0gbmV3IENvbW1lbnQoY29tbWVudElkLCB0aGlzLmRhdGEuc3RvcmFnZVtcImlkXCJdLCByZXN1bHQudGV4dCk7XHJcbiAgICAgICAgICAgIGNvbW1lbnQucmlnaHRzID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5waG90b0NvbW1lbnRzLnB1c2goY29tbWVudCk7XHJcbiAgICAgICAgICAgIHJlc3VsdC50ZXh0ID0gXCJcIjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQ29tbWVudChjb21tZW50SWQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIllvdSBjbGljayBjb21tZW50IGlkIFwiICsgY29tbWVudElkKTtcclxuICAgICAgICB0aGlzLnNlcnZlci5yZW1vdmVDb21tZW50KGNvbW1lbnRJZCk7XHJcbiAgICB9XHJcblxyXG59Il19